# US-132: Ntfy on Story Completion Research

**Research Date:** 2026-01-26  
**Story:** US-132 - Research: Ntfy on Story Completion  
**Model:** kiro  

## Overview

Research into sending rich ntfy notifications when each story completes - for both Ralph autonomous execution AND direct Claude sessions (repoClaude/golemClaude).

## Current Implementation Analysis

### 1. Ntfy.ts Implementation Review

**Location:** `bun/core/ntfy.ts` and `ralph-ui/src/runner/ntfy.ts`

**Basic Interface (bun/core/ntfy.ts):**
```typescript
interface NotificationOptions {
  topic: string;
  title: string;
  body: string;
  priority?: "min" | "low" | "default" | "high" | "urgent";
  tags?: string[];
}
```

**Rich Interface (ralph-ui/src/runner/ntfy.ts):**
```typescript
interface RichNtfyOptions {
  topic: string;
  event: "complete" | "blocked" | "error" | "iteration" | "max_iterations" | "retry";
  storyId?: string;
  model?: string;
  iteration?: number;
  pendingStories?: number;
  pendingCriteria?: number;
  cost?: number;
  projectName?: string;
  message?: string;
}
```

**Key Functions:**
- `sendRichNtfy()` - Main rich notification sender
- `notifyStoryComplete()` - Story completion notifications
- `notifyIterationComplete()` - Iteration progress notifications
- `buildRichBody()` - 3-line body format builder

### 2. Story Completion Detection (runner/index.ts)

**Location:** `ralph-ui/src/runner/index.ts`

**Key Detection Points:**
- Line 200-210: `hasCompletePromise(spawnResult.stdout)` - Detects `<promise>COMPLETE</promise>`
- Line 215-225: `hasAllBlockedPromise(spawnResult.stdout)` - Detects `<promise>ALL_BLOCKED</promise>`
- Line 280-285: Story completion triggers `notifyIterationComplete()`
- Line 260-265: PRD completion triggers `notifyPRDComplete()`

**Current Notification Triggers:**
- Individual iteration completion (after each story)
- Full PRD completion (all stories done)
- Error conditions and retries
- Blocked story detection

### 3. Available Data (runner/types.ts)

**IterationResult Interface:**
```typescript
interface IterationResult {
  iteration: number;
  storyId: string;
  success: boolean;
  hasComplete: boolean;
  hasBlocked: boolean;
  durationMs: number;
  error?: string;
}
```

**Missing Data for Rich Notifications:**
- Cost/token tracking (not currently captured per iteration)
- Next story preview (would need to read index.json)
- Model information (available in config but not passed to result)

## Proposed Design

### Title Format
```
[Ralph/Claude] {repo} {status-icon} | {story-id}
```

**Examples:**
- `[Ralph] claude-golem âœ… | US-132`
- `[Claude] songscript âš ï¸ | BUG-045`
- `[Ralph] domica-app ðŸ”„ | MP-128`

### Body Format (3 lines)
```
Line 1: {story-title} â€¢ {model}
Line 2: ${cost} â€¢ {tokens}k tokens â€¢ {duration}
Line 3: Next: {next-story-id} - {next-story-title}
```

**Example:**
```
Research: Ntfy on Story Completion â€¢ kiro
$0.02 â€¢ 1.2k tokens â€¢ 45s
Next: US-115 - Add timestamp tracking to PRD criteria
```

### Icon Mapping

| Status | Icon | Event Type | Usage |
|--------|------|------------|-------|
| âœ… | `white_check_mark` | complete | Story completed successfully |
| ðŸ”„ | `arrows_counterclockwise` | iteration | Story in progress |
| âš ï¸ | `warning` | blocked | Story blocked by dependency |
| âŒ | `x` | error | Story failed with error |
| â° | `hourglass` | retry | Story being retried |
| ðŸŽ¯ | `dart` | max_iterations | Hit iteration limit |

## RepoClaude Integration Research

### Current Pattern Analysis

**Location:** `lib/ralph-registry.zsh` lines 800-900

**Existing repoClaude Functions:**
- `{name}Claude()` - Generated by `repoGolem()` function
- Supports notification flags: `-QN`, `-SN`, `-VN`
- Creates temp config: `/tmp/.claude_notify_config_{project}.json`

**Current Notification Setup:**
```bash
# In {name}Claude function
if [[ -n "$notify_mode" ]]; then
  echo "{\"name\":\"${capitalized_name} Claude\",\"topic\":\"${ntfy_topic}\",\"quiet\":${quiet_val},\"verbose\":${verbose_val},\"cwd\":\"$path\"}" > "/tmp/.claude_notify_config_${project_key}.json"
fi
```

### Proposed repoClaude Enhancement

**Hook Point:** End of Claude session (when user exits)

**Implementation Strategy:**
1. **Session End Detection:** Use `trap` to detect Claude CLI exit
2. **Story Detection:** Check if current directory has `prd-json/` or completed work
3. **Notification Trigger:** Send ntfy with session summary

**Example Implementation:**
```bash
function ${lowercase_name}Claude() {
  # ... existing setup ...
  
  # Set up session end notification
  local session_start=$(date +%s)
  trap '_ralph_notify_session_end "$project_key" "$session_start"' EXIT
  
  claude "${claude_args[@]}"
}

function _ralph_notify_session_end() {
  local project="$1"
  local start_time="$2"
  local duration=$(($(date +%s) - start_time))
  
  # Check for completed work (git commits, PRD changes, etc.)
  # Send ntfy notification with session summary
}
```

## Implementation Recommendations

### Phase 1: Enhance Ralph Notifications
1. **Add cost/token tracking** to IterationResult
2. **Add next story preview** to notification body
3. **Implement new title format** with repo name and icons
4. **Update RichNtfyOptions** to include missing fields

### Phase 2: RepoClaude Integration
1. **Add session end hooks** to generated launcher functions
2. **Implement story completion detection** for interactive sessions
3. **Create unified notification format** for both Ralph and Claude sessions
4. **Add configuration options** for notification preferences

### Phase 3: Advanced Features
1. **Cost tracking integration** with existing cost system
2. **Multi-project notification routing** (different topics per project)
3. **Notification history** and analytics
4. **Integration with other CLIs** (OpenCode, Gemini)

## Technical Considerations

### Data Flow
```
Story Completion â†’ IterationResult â†’ notifyStoryComplete() â†’ sendRichNtfy() â†’ ntfy.sh
```

### Missing Pieces
- **Cost calculation:** Need to integrate with existing cost tracking
- **Token counting:** Requires parsing Claude CLI output or API response
- **Next story lookup:** Need to read and parse index.json
- **Repo name detection:** Use basename(cwd) or git remote parsing

### Compatibility
- **Existing notifications:** Must not break current Ralph UI notifications
- **Configuration:** Should respect existing ntfy topic and flag settings
- **Error handling:** Graceful fallback if ntfy service unavailable

## Conclusion

The foundation for rich story completion notifications exists in the current codebase. The main gaps are:

1. **Data enrichment:** Adding cost, tokens, and next story info
2. **Format standardization:** Implementing the proposed title/body format
3. **RepoClaude integration:** Adding session end hooks to interactive sessions

The implementation should be incremental, starting with enhancing Ralph notifications and then extending to interactive Claude sessions.
